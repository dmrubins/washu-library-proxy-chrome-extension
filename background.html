<html>
<head>
<script src="./parseuri.js" type="text/javascript"></script>
<script src="./becker-journals.js" type="text/javascript"></script>
<script src="./danforth-journals.js" type="text/javascript"></script>
<script src="./intersect-journals.js" type="text/javascript"></script>
<script>
  // Figure out if we're @ WU/BJC/SLCH/Danforth or off-campus.
  var onNetwork = false;
  var proxyURL = '.beckerproxy.wustl.edu';

  // This will pass an HTTP_ORIGIN flag with the Chrome Extension ID so Becker
  // can contact me or block the extension if it causes any problems.
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "https://becker.wustl.edu/sites/all/themes/bml_theme2/js/network-indicator-script3.php", true);
  xhr.onreadystatechange = function() {
  if (xhr.readyState == 4) {
    // alert(xhr.responseText);
    var resp = JSON.parse(xhr.responseText.substring(1, xhr.responseText.length-1));
    if (resp.networkTag == "WUSTL") {
      onNetwork = true;
    } else if (resp.networkTag == "SLCH" || resp.networkTag == "BJH") {
      onNetwork = true;
      proxyURL = '.beckerproxy2a.wucon.wustl.edu';
    };
   }
  }
  xhr.send();


  // Perform URL parsing and (maybe) redirection
  function checkURLforRedirection(tab) {
    var parsedURL = parseUri(tab.url);
    if (journals.list.indexOf(parsedURL.host) !== -1) {
      doRedirectToProxy(tab, parsedURL);
    }
  }

  // Redirect the page using the auto-determined proxy URL
  // Modularize so we only parse the URL once (parsing is expensive!)
  function doRedirectToProxy(tab, parsed) {
    var beckerURL =  parsed.protocol + "://" + parsed.host + proxyURL + parsed.relative;
    chrome.tabs.update(tab.id, {url: beckerURL});
  }

  // If users have manually clicked on the icon, we've failed.
  // Submit the journal TLD to a logger so we can update our database.
  function uploadJournalToDatabase(theUrl) {
    var uploader = new XMLHttpRequest();
      uploader.open("GET", "https://update.epoxate.com/becker-extension/log.py?" + encodeURIComponent(theUrl), true);
      uploader.send();
  };


  // Listen for tab url changes
  chrome.tabs.onUpdated.addListener(function(tabid, changeinfo, tab) {
    // If users refresh, changeinfo.url is null (don't trigger)
    // Should we check for redirect loops, like with web.mit.edu?
    if (changeinfo.status == "loading" && changeinfo.url != null) {
      checkURLforRedirection(tab);
    };
  });

  // Listen to clicking on our button.
  chrome.browserAction.onClicked.addListener(function (tab) {
    // Parse and redirect.
    var parsedURL = parseUri(tab.url);
    doRedirectToProxy(tab, parsedURL);

    // If we've been manually clicked (and auto-triggering is enabled), the journal
    // is missing from our list. Let's send the journal URL to the cloud logger.
    if (!tab.incognito) {
      uploadJournalToDatabase(parsedURL.host);
    };
});

</script>
</head>
</html>
