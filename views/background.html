<html>
<head>
    <script src="../javascript/lso.js" type="text/javascript"></script>
    <script src="../javascript/parseuri.js" type="text/javascript"></script>
    <script src="../javascript/journals.js" type="text/javascript"></script>
    <script>
        // chrome.browserAction.setBadgeBackgroundColor({color: [0, 110, 81, 255]});
        // chrome.browserAction.setBadgeText({text: "ON"});
        // Parse some local storage objects!
        parseLocalStorage();
        // Figure out if we're @ WU/BJC/SLCH/Danforth or off-campus.
        var onNetwork = false;
        // TODO: Consider redirect with /?url= parameter instead if not logged in.
        var danforthProxyURL = '.libproxy.wustl.edu';
        var beckerProxyURL = '.beckerproxy.wustl.edu';

        // TODO: Once per session, append "?holding=wustlmlib" to PubMed.
        var rewrotePubMedThisSession = false;

        // For debugging
        var networkTag = '';

        // This will pass an HTTP_ORIGIN flag with the Chrome Extension ID so Becker
        // can contact me or block the extension if it causes any problems.
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "https://becker.wustl.edu/sites/all/themes/bml_theme2/js/network-indicator-script3.php", true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                var resp = JSON.parse(xhr.responseText.substring(1, xhr.responseText.length-1));
                if (resp.networkTag == "WUSTL" || resp.networkTag == "WUSM") {
                    onNetwork = true;
                } else if (resp.networkTag == "SLCH" || resp.networkTag == "BJH") {
                    onNetwork = true;
                    beckerProxyURL = '.beckerproxy2a.wucon.wustl.edu';
                }
                networkTag = resp.networkTag;
            }
        };
        xhr.send();

        // The user wants auto-redirection and is off-network,
        // so we perform URL parsing and (maybe) redirection
        function checkURLforRedirection(tab) {
            var parsedURL = parseUri(tab.url);
            if (intersect_journals.list.indexOf(parsedURL.host) !== -1) {
                if (optPreferDanforth || (optEnableDanforth && !optEnableBecker)) {
                    doRedirectToProxy(tab, parsedURL, danforthProxyURL);
                    return true;
                } else {
                    doRedirectToProxy(tab, parsedURL, beckerProxyURL);
                    return true;
                }
            }

            // We're still here, so the journal is not in intersect_journals.
            if (optEnableDanforth) {
                if (danforth_journals.list.indexOf(parsedURL.host) !== -1) {
                    doRedirectToProxy(tab, parsedURL, danforthProxyURL);
                    return true;
                }
            }
            if (optEnableBecker) {
                if (becker_journals.list.indexOf(parsedURL.host) !== -1) {
                    doRedirectToProxy(tab, parsedURL, beckerProxyURL);
                    return true;
                } else if (!rewrotePubMedThisSession && parsedURL.host == "www.ncbi.nlm.nih.gov") {
                    // Redirect PubMed journals to add ?holding flag.
                    // TODO: Redirect for PMC articles, too?
                    if (parsedURL.relative == "/pubmed/" || parsedURL.relative == "/pubmed"
                            || parsedURL.relative == "/pmc/" || parsedURL.relative.match(/^\/pubmed\/\d{6,}$/)) {
                        // Redirect with no proxy url, but an appendString
                        doRedirectToProxy(tab, parsedURL, "", "?holding=wustlmlib");
                        rewrotePubMedThisSession = true;
                        return true;
                    }
                }
            }
            return false;
        }

        // Redirect the page using the auto-determined proxy URL
        // Modularize so we only parse the URL once (parsing is expensive!)
        function doRedirectToProxy(tab, parsed, proxyURL, appendString) {
            if (!appendString) { appendString = ''; }
            var proxifiedURL =  parsed.protocol + "://" + parsed.host + proxyURL + parsed.relative + appendString;
            chrome.tabs.update(tab.id, {url: proxifiedURL});
        }

        // If users have manually clicked on the icon, we've failed.
        // Submit the journal domain to a logger so we can update our database.
        // TODO: Add addtl. log data (version, on-network detection, etc.)
        function uploadJournalToDatabase(theUrl) {
            var uploader  = new XMLHttpRequest();
            var logString = "url:" + encodeURIComponent(theUrl) + ",auto:"+ optAutoRedirect +
                    ",onNet:" + onNetwork + ",tag:" + networkTag;
            uploader.open("GET", "https://update.epoxate.com/becker-extension/log.py?" + logString, true);
            uploader.send();
        }

        // Listen for tab url changes
        chrome.tabs.onUpdated.addListener(function(tabid, changeinfo, tab) {
            // If users refresh, changeinfo.url is null (don't trigger)
            // Should we check for redirect loops, like with web.mit.edu?
            if (optAutoRedirect && !onNetwork && changeinfo.status == "loading" && changeinfo.url != null) {
                checkURLforRedirection(tab);
            }
        });

        // Listen to clicking on our button.
        chrome.browserAction.onClicked.addListener(function (tab) {
            // Parse and redirect.
            var parsedURL = parseUri(tab.url);

            // We check for HTTP/HTTPS only (no chrome://), and that "proxy.wustl.edu" isn't at the end of the
            // string, otherwise we're probably already at [becker|lib]proxy.wustl.edu.
            if ((parsedURL.protocol == 'http' || parsedURL.protocol == 'https')
                    && parsedURL.host.substring(parsedURL.host.length-15) != 'proxy.wustl.edu') {
                // TODO: Handle Danforth differently, since they don't seem to like SSL as much.
                // TODO: Consider dropping HTTPS support? Is this useful?
                if (parsedURL.protocol == 'https') {
                    parsedURL.host = parsedURL.host.replace(/\./g, '-');
                }
                if (optPreferDanforth || (!optEnableBecker && optEnableDanforth)) {
                    doRedirectToProxy(tab, parsedURL, danforthProxyURL);
                } else {
                    doRedirectToProxy(tab, parsedURL, beckerProxyURL);
                }
            }

            // If we've been manually clicked (and auto-triggering is enabled), the journal
            // is missing from our list. Let's send the journal URL to the cloud logger.
            // We log non-http/https here in case we're missing something (ftp sites for journal data?)
            if (!tab.incognito && !optUsageOptOut) {
                uploadJournalToDatabase(parsedURL.host);
            }
        });

    </script>
</head>
</html>
